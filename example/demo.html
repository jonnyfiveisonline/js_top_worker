<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>js_top_worker Feature Demo</title>
  <style>
    :root {
      --bg-primary: #1e1e2e;
      --bg-secondary: #313244;
      --bg-tertiary: #45475a;
      --text-primary: #cdd6f4;
      --text-secondary: #a6adc8;
      --accent: #89b4fa;
      --accent-hover: #b4befe;
      --success: #a6e3a1;
      --error: #f38ba8;
      --warning: #fab387;
      --border: #585b70;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2rem;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px 15px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--warning);
    }

    .status-indicator.ready { background: var(--success); }
    .status-indicator.error { background: var(--error); }

    .status-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }

    .demo-card {
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .card-header {
      padding: 15px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 1rem;
      color: var(--accent);
    }

    .card-badge {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--bg-primary);
      color: var(--text-secondary);
    }

    .card-body {
      padding: 20px;
    }

    .code-input {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      resize: vertical;
      margin-bottom: 10px;
    }

    .code-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .output-area {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      min-height: 80px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.85rem;
    }

    .output-line {
      margin-bottom: 5px;
    }

    .output-line.stdout { color: var(--text-primary); }
    .output-line.stderr { color: var(--error); }
    .output-line.result { color: var(--success); }
    .output-line.info { color: var(--text-secondary); font-style: italic; }

    .mime-output {
      background: white;
      border-radius: 6px;
      padding: 10px;
      margin-top: 10px;
    }

    .completion-list {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
    }

    .completion-item {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .completion-item:last-child {
      border-bottom: none;
    }

    .completion-name {
      color: var(--accent);
    }

    .completion-kind {
      font-size: 0.75rem;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 3px;
    }

    .type-info {
      padding: 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--success);
    }

    .error-list {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
    }

    .error-item {
      padding: 8px;
      margin-bottom: 8px;
      border-left: 3px solid var(--error);
      background: rgba(243, 139, 168, 0.1);
    }

    .error-item.warning {
      border-left-color: var(--warning);
      background: rgba(250, 179, 135, 0.1);
    }

    .env-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .env-btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-secondary);
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.8rem;
    }

    .env-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(137, 180, 250, 0.1);
    }

    .log-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      max-height: 200px;
      overflow-y: auto;
      padding: 10px 20px;
      font-size: 0.8rem;
    }

    .log-entry {
      color: var(--text-secondary);
      margin-bottom: 3px;
    }

    .log-entry.error { color: var(--error); }
    .log-entry.success { color: var(--success); }

    .full-width {
      grid-column: 1 / -1;
    }

    .hidden { display: none; }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>js_top_worker Feature Demo</h1>
      <p class="subtitle">OCaml Toplevel in the Browser via WebWorker</p>
    </header>

    <div class="status-bar">
      <div class="status-indicator" id="status-indicator"></div>
      <span class="status-text" id="status-text">Initializing...</span>
    </div>

    <div class="demo-grid">
      <!-- Basic Execution -->
      <div class="demo-card">
        <div class="card-header">
          <span class="card-title">Basic Execution</span>
          <span class="card-badge">exec</span>
        </div>
        <div class="card-body">
          <textarea class="code-input" id="exec-input">let greet name = Printf.sprintf "Hello, %s!" name;;
greet "OCaml";;</textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runExec()">Execute</button>
            <button class="btn btn-secondary" onclick="clearOutput('exec-output')">Clear</button>
          </div>
          <div class="output-area" id="exec-output"></div>
        </div>
      </div>

      <!-- Multiple Environments -->
      <div class="demo-card">
        <div class="card-header">
          <span class="card-title">Multiple Environments</span>
          <span class="card-badge">isolation</span>
        </div>
        <div class="card-body">
          <div class="env-selector" id="env-selector">
            <button class="env-btn active" data-env="">default</button>
          </div>
          <div class="btn-row">
            <button class="btn btn-secondary" onclick="createEnv()">+ New Env</button>
            <button class="btn btn-secondary" onclick="listEnvs()">List Envs</button>
          </div>
          <textarea class="code-input" id="env-input">let env_value = 42;;</textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runInEnv()">Execute in Selected Env</button>
          </div>
          <div class="output-area" id="env-output"></div>
        </div>
      </div>

      <!-- MIME Output -->
      <div class="demo-card">
        <div class="card-header">
          <span class="card-title">MIME Output</span>
          <span class="card-badge">rich output</span>
        </div>
        <div class="card-body">
          <textarea class="code-input" id="mime-input">(* SVG output *)
let svg = {|<svg width="100" height="100">
  <circle cx="50" cy="50" r="40" fill="#89b4fa"/>
  <text x="50" y="55" text-anchor="middle" fill="white">OCaml</text>
</svg>|};;
Mime_printer.push "image/svg" svg;;</textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runMime()">Execute</button>
            <button class="btn btn-secondary" onclick="loadMimeExamples()">Examples</button>
          </div>
          <div class="output-area" id="mime-output"></div>
          <div class="mime-output hidden" id="mime-rendered"></div>
        </div>
      </div>

      <!-- Autocomplete -->
      <div class="demo-card">
        <div class="card-header">
          <span class="card-title">Autocomplete</span>
          <span class="card-badge">complete_prefix</span>
        </div>
        <div class="card-body">
          <textarea class="code-input" id="complete-input">List.ma</textarea>
          <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">
            Enter partial code and click Complete to see suggestions
          </p>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runComplete()">Complete</button>
          </div>
          <div class="completion-list" id="complete-output"></div>
        </div>
      </div>

      <!-- Type Information -->
      <div class="demo-card">
        <div class="card-header">
          <span class="card-title">Type Information</span>
          <span class="card-badge">type_enclosing</span>
        </div>
        <div class="card-body">
          <textarea class="code-input" id="type-input">let f x = List.map (fun y -> y + 1) x</textarea>
          <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">
            Position (0-indexed): <input type="number" id="type-pos" value="8" style="width: 50px; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); padding: 4px;">
          </p>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runTypeEnclosing()">Get Type</button>
          </div>
          <div class="type-info" id="type-output">Click "Get Type" to see type information</div>
        </div>
      </div>

      <!-- Error Reporting -->
      <div class="demo-card">
        <div class="card-header">
          <span class="card-title">Error Reporting</span>
          <span class="card-badge">query_errors</span>
        </div>
        <div class="card-body">
          <textarea class="code-input" id="errors-input">let x : string = 42
let unused = "hello"
let y = unknown_function ()</textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runQueryErrors()">Check Errors</button>
          </div>
          <div class="error-list" id="errors-output">Click "Check Errors" to analyze code</div>
        </div>
      </div>

      <!-- Directives -->
      <div class="demo-card full-width">
        <div class="card-header">
          <span class="card-title">Directives</span>
          <span class="card-badge">#show, #install_printer, etc.</span>
        </div>
        <div class="card-body">
          <div class="btn-row" style="flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="runDirective('#show List;;')">show List</button>
            <button class="btn btn-secondary" onclick="runDirective('#show_type option;;')">show_type option</button>
            <button class="btn btn-secondary" onclick="runDirective('#help;;')">help</button>
            <button class="btn btn-secondary" onclick="runDirective('#print_depth 5;;')">print_depth 5</button>
            <button class="btn btn-secondary" onclick="runDirective('#warnings \"+a\";;')">warnings +a</button>
          </div>
          <textarea class="code-input" id="directive-input">#show List.map;;</textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runDirective()">Run Directive</button>
          </div>
          <div class="output-area" id="directive-output"></div>
        </div>
      </div>

      <!-- Custom Printers -->
      <div class="demo-card">
        <div class="card-header">
          <span class="card-title">Custom Printers</span>
          <span class="card-badge">#install_printer</span>
        </div>
        <div class="card-body">
          <textarea class="code-input" id="printer-input">type color = Red | Green | Blue;;

let pp_color fmt c =
  Format.fprintf fmt "[COLOR:%s]"
    (match c with Red -> "red" | Green -> "green" | Blue -> "blue");;

#install_printer pp_color;;

[Red; Green; Blue];;</textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runPrinter()">Execute</button>
          </div>
          <div class="output-area" id="printer-output"></div>
        </div>
      </div>

      <!-- Library Loading -->
      <div class="demo-card">
        <div class="card-header">
          <span class="card-title">Library Loading</span>
          <span class="card-badge">#require</span>
        </div>
        <div class="card-body">
          <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">
            Libraries must be prepared with <code>jtw opam</code> first.
          </p>
          <textarea class="code-input" id="require-input">#require "str";;
Str.split (Str.regexp ",") "a,b,c";;</textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runRequire()">Execute</button>
          </div>
          <div class="output-area" id="require-output"></div>
        </div>
      </div>

      <!-- Toplevel Script -->
      <div class="demo-card full-width">
        <div class="card-header">
          <span class="card-title">Toplevel Script Execution</span>
          <span class="card-badge">exec_toplevel</span>
        </div>
        <div class="card-body">
          <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">
            Toplevel scripts use "# " prefix for input lines. Output is indented.
          </p>
          <textarea class="code-input" id="toplevel-input" style="min-height: 150px;"># let square x = x * x;;
# let numbers = [1; 2; 3; 4; 5];;
# List.map square numbers;;</textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runToplevel()">Execute Script</button>
          </div>
          <div class="output-area" id="toplevel-output" style="min-height: 150px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="log-panel" id="log-panel">
    <div id="log-entries"></div>
  </div>

  <script src="demo.js"></script>
</body>
</html>
